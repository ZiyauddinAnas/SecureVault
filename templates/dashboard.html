{% extends "base.html" %}

{% block title %}SecureVault - Dashboard{% endblock %}

{% block content %}
<a href="/logout" class="logout-btn">
    <i class="fas fa-sign-out-alt"></i> Logout
</a>

<div class="container">
    <div class="header">
        <h1><i class="fas fa-vault"></i> SecureVault Dashboard</h1>
        <p>Manage your secure credentials and email aliases</p>
        <div style="margin-top: 16px; padding: 16px; background: rgba(255, 255, 255, 0.05); border-radius: 12px; border: 1px solid rgba(255, 255, 255, 0.1);">
            <p style="color: rgba(255, 255, 255, 0.8); margin: 0; font-size: 0.875rem;">
                <i class="fas fa-user"></i> Logged in as: <strong>{{ session.user_email }}</strong>
                {% if session.user_name %}
                    ({{ session.user_name }})
                {% endif %}
            </p>
        </div>
    </div>

    <!-- Generate New Credentials Form -->
    <div class="generate-form">
        <h3><i class="fas fa-plus-circle"></i> Generate New Credentials</h3>
        <form id="generateForm">
            <div class="form-group">
                <label for="site_name" style="display: block; margin-bottom: 12px; font-weight: 600; color: white; font-size: 0.875rem;">
                    <i class="fas fa-globe"></i> Website/Service Name
                </label>
                <input type="text" id="site_name" name="site_name" class="form-control" 
                       placeholder="e.g., Netflix, GitHub, Amazon" required>
            </div>
            <button type="submit" class="btn">
                <i class="fas fa-magic"></i> Generate Credentials
            </button>
        </form>
    </div>

    <!-- Search Box -->
    <div class="search-box">
        <input type="text" id="searchInput" class="search-input" 
               placeholder="🔍 Search your saved credentials...">
    </div>

    <!-- Credentials List -->
    <div id="credentialsContainer">
        <div class="card">
            <div class="empty-state">
                <i class="fas fa-spinner fa-spin"></i>
                <h3>Loading your credentials...</h3>
                <p>Please wait while we fetch your data</p>
            </div>
        </div>
    </div>

    <!-- Generated Credentials Modal -->
    <div id="credentialsModal" class="modal">
        <div class="modal-content">
            <h3 style="margin-bottom: 24px; color: white; font-size: 1.5rem; font-weight: 600;">
                <i class="fas fa-check-circle" style="color: #22c55e;"></i> Credentials Generated!
            </h3>
            <div id="generatedCredentials"></div>
            <div style="text-align: center; margin-top: 24px;">
                <button onclick="closeModal()" class="btn">Close</button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Load credentials on page load
    loadCredentials();
    
    // Search functionality
    let searchTimeout;
    const searchInput = document.getElementById('searchInput');
    searchInput.addEventListener('input', function() {
        clearTimeout(searchTimeout);
        const searchTerm = this.value;
        
        searchTimeout = setTimeout(() => {
            if (searchTerm.trim()) {
                searchCredentials(searchTerm);
            } else {
                loadCredentials();
            }
        }, 300);
    });
    
    // Generate credentials form
    const generateForm = document.getElementById('generateForm');
    generateForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const siteName = document.getElementById('site_name').value.trim();
        if (!siteName) {
            showAlert('Please enter a site name', 'error');
            return;
        }
        
        // Show loading state
        const submitBtn = this.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<div class="loading"></div> Generating...';
        submitBtn.disabled = true;
        
        fetch('/generate_credentials', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: new URLSearchParams({ site_name: siteName })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showGeneratedCredentials(data.credentials);
                document.getElementById('site_name').value = '';
                loadCredentials(); // Refresh the list
            } else {
                showAlert(data.message || 'Failed to generate credentials', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('An error occurred while generating credentials', 'error');
        })
        .finally(() => {
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
        });
    });
});

function loadCredentials() {
    fetch('/get_credentials')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayCredentials(data.credentials);
            } else {
                showAlert(data.message || 'Failed to load credentials', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('An error occurred while loading credentials', 'error');
        });
}

function searchCredentials(searchTerm) {
    fetch(`/search_credentials?q=${encodeURIComponent(searchTerm)}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayCredentials(data.credentials);
            } else {
                showAlert(data.message || 'Search failed', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('An error occurred during search', 'error');
        });
}

function displayCredentials(credentials) {
    const container = document.getElementById('credentialsContainer');
    
    if (credentials.length === 0) {
        container.innerHTML = `
            <div class="card">
                <div class="empty-state">
                    <i class="fas fa-inbox"></i>
                    <h3>No Credentials Found</h3>
                    <p>Generate your first set of credentials using the form above</p>
                </div>
            </div>
        `;
        return;
    }
    
    let html = '';
    credentials.forEach(function(cred) {
        const createdDate = new Date(cred.created_at).toLocaleDateString();
        
        html += `
            <div class="credential-item" data-id="${cred.id}">
                <div class="credential-header">
                    <div class="site-name">
                        <i class="fas fa-globe"></i> ${cred.site_name}
                    </div>
                    <div class="credential-actions">
                        <button onclick="copyToClipboard('${cred.email_alias}')" class="copy-btn">
                            <i class="fas fa-copy"></i> Email
                        </button>
                        <button onclick="deleteCredential(${cred.id})" class="btn btn-danger" style="padding: 8px 16px; font-size: 12px;">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
                <div class="credential-details">
                    <div class="detail-item">
                        <div class="detail-label">Email Alias</div>
                        <div class="detail-value">${cred.email_alias}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Password</div>
                        <div class="detail-value">
                            <span id="password-${cred.id}" style="display: none;">${cred.password_hash}</span>
                            <span id="password-mask-${cred.id}">••••••••••••••••</span>
                            <button onclick="togglePassword(${cred.id})" class="copy-btn" style="margin-left: 8px;">
                                <i class="fas fa-eye" id="eye-${cred.id}"></i>
                            </button>
                        </div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Created</div>
                        <div class="detail-value">${createdDate}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Actions</div>
                        <div class="detail-value">
                            <button onclick="copyToClipboard('${cred.email_alias}')" class="copy-btn" style="margin-right: 8px;">
                                <i class="fas fa-copy"></i> Email
                            </button>
                            <button onclick="copyToClipboard('${cred.password_hash}')" class="copy-btn">
                                <i class="fas fa-copy"></i> Password
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

function showGeneratedCredentials(credentials) {
    const modal = document.getElementById('credentialsModal');
    const container = document.getElementById('generatedCredentials');
    
    container.innerHTML = `
        <div style="background: rgba(255, 255, 255, 0.05); padding: 24px; border-radius: 12px; margin-bottom: 16px; border: 1px solid rgba(255, 255, 255, 0.1);">
            <div style="margin-bottom: 16px;">
                <strong style="color: white;">Site:</strong> 
                <span style="color: rgba(255, 255, 255, 0.8);">${credentials.site_name}</span>
            </div>
            <div style="margin-bottom: 16px;">
                <strong style="color: white;">Email Alias:</strong> 
                <span style="font-family: monospace; background: rgba(255, 255, 255, 0.1); padding: 8px 12px; border-radius: 8px; color: white; display: inline-block; margin-left: 8px;">
                    ${credentials.email}
                </span>
                <button onclick="copyToClipboard('${credentials.email}')" class="copy-btn" style="margin-left: 8px;">
                    <i class="fas fa-copy"></i>
                </button>
            </div>
            <div>
                <strong style="color: white;">Password:</strong> 
                <span style="font-family: monospace; background: rgba(255, 255, 255, 0.1); padding: 8px 12px; border-radius: 8px; color: white; display: inline-block; margin-left: 8px;">
                    ${credentials.password}
                </span>
                <button onclick="copyToClipboard('${credentials.password}')" class="copy-btn" style="margin-left: 8px;">
                    <i class="fas fa-copy"></i>
                </button>
            </div>
        </div>
        <div style="background: rgba(34, 197, 94, 0.1); color: #22c55e; padding: 16px; border-radius: 12px; border: 1px solid rgba(34, 197, 94, 0.2);">
            <i class="fas fa-check-circle"></i> Credentials have been saved to your vault!
        </div>
    `;
    
    modal.style.display = 'block';
}

function closeModal() {
    document.getElementById('credentialsModal').style.display = 'none';
}

function togglePassword(id) {
    const passwordSpan = document.getElementById(`password-${id}`);
    const passwordMask = document.getElementById(`password-mask-${id}`);
    const eyeIcon = document.getElementById(`eye-${id}`);
    
    if (passwordSpan.style.display === 'none') {
        passwordSpan.style.display = 'inline';
        passwordMask.style.display = 'none';
        eyeIcon.className = 'fas fa-eye-slash';
    } else {
        passwordSpan.style.display = 'none';
        passwordMask.style.display = 'inline';
        eyeIcon.className = 'fas fa-eye';
    }
}

function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(function() {
        showAlert('Copied to clipboard!', 'success');
    }).catch(function() {
        showAlert('Failed to copy to clipboard', 'error');
    });
}

function deleteCredential(id) {
    if (!confirm('Are you sure you want to delete this credential?')) {
        return;
    }
    
    fetch('/delete_credential', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: new URLSearchParams({ id: id })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('Credential deleted successfully', 'success');
            loadCredentials(); // Refresh the list
        } else {
            showAlert(data.message || 'Failed to delete credential', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('An error occurred while deleting the credential', 'error');
    });
}

function showAlert(message, type) {
    const alertClass = type === 'success' ? 'alert-success' : 'alert-error';
    const alertHtml = `<div class="alert ${alertClass}">${message}</div>`;
    
    // Remove existing alerts
    const existingAlerts = document.querySelectorAll('.alert');
    existingAlerts.forEach(alert => alert.remove());
    
    // Add new alert at the top
    const container = document.querySelector('.container');
    container.insertAdjacentHTML('afterbegin', alertHtml);
    
    // Auto-remove success alerts
    if (type === 'success') {
        setTimeout(() => {
            const alerts = document.querySelectorAll('.alert');
            alerts.forEach(alert => alert.style.opacity = '0');
        }, 3000);
    }
}
</script>
{% endblock %} 